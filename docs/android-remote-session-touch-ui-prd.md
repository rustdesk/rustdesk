1. # Product Requirements Document：Android 远控会话触控交互与虚拟按键增强 (v1.1)

   **版本**：1.1（修订版）  
   **日期**：2026-01-16  
   **修订人**：Antigravity  
   **变更摘要**：优化自动化测试验收口径，调整交付顺序为分组里程碑模式。

   ---

   ## 一、执行摘要

   本需求面向 RustDesk Android（Flutter）端的“远控会话”界面，重构触屏手势与虚拟输入控件，使平板/触控设备在不依赖物理鼠标与键盘的情况下，也能高效、稳定地完成桌面远控操作。

   核心交付包含：触控手势映射到鼠标左/右键与拖动、移除双指缩放并改为双指滚轮模式（带可调灵敏度）、新增可配置的组合快捷键按钮面板与软键盘呼出按钮、增加设置项与行为开关、以及新增可拖动且可持久化位置的悬浮控件。

   ---

   ## 二、问题陈述

   **现状**：  
   - 远控会话在触屏设备上存在操作效率与可预期性问题：常用鼠标操作（左键、右键、拖动、滚轮）不够直观；缩放/滚轮手势冲突；虚拟键盘与快捷键支持不够直接。

   **目标**：  
   - 让触屏操作“像用鼠标一样自然”：单击/右击/拖动/滚轮直接完成。  
   - 降低误触与学习成本，确保手势互不冲突。  
   - 提供可扩展的虚拟快捷键能力。  

   ---

   ## 三、成功指标（KPI）

   **体验指标**：  
   - 任务耗时：完成“右键菜单-复制/粘贴-滚动查看”流程耗时降低 20%。  
   - 误触率：双指缩放误触为 0（功能移除）。  

   **功能指标**：  
   - 组合快捷键面板支持 ≥ 30 个配置。  
   - 双指滚轮灵敏度可调且生效。  

   ---

   ## 四、用户画像

   主要面向使用 Android 平板远程控制 Windows/macOS/Linux 桌面的用户，旨在无键鼠环境下提供高生产力体验。

   ---

   ## 五、范围与优先级

   **适用范围**：仅 Android 端 **远控会话页面** (`remote_page.dart`)。  
   **明确不做**：非远控会话页面手势；远控画面内的画布缩放功能（本版本移除）。

   ---

   ## 六、用户故事与验收标准

   ### Story 1：点击=鼠标左键单击
   **验收标准：**
   - 在远控画面单指点击，远端收到左键点击（按下+抬起）。
   - 必须通过 U2 验证：Input Event Log 显示 `left_click` 事件及坐标。

   ### Story 2：长按=鼠标右键单击
   **验收标准：**
   - 单指长按触发右键单击。
   - 若长按后进入拖动（Story 4），则**不**触发右键单击。
   - 必须通过 U2 验证：Input Event Log 显示 `right_click`，且无 `left_click`。

   ### Story 3：快速拖动=鼠标左键按住拖动
   **验收标准：**
   - 单指拖动触发左键按住移动，松手后抬起。
   - 必须通过 U2 验证：Input Event Log 显示 `left_drag` 序列（Down -> Move -> Up）。

   ### Story 4：长按后快速拖动=鼠标右键按住拖动
   **验收标准：**
   - 长按后保持按住并拖动，触发右键按住移动。
   - 与 Story 2 互斥：进入拖动状态后，松手时不触发右键单击。
   - 必须通过 U2 验证：Input Event Log 显示 `right_drag` 序列。

   ### Story 5：移除双指缩放
   **验收标准：**
   - 双指操作不再触发画布缩放/平移；UI 无缩放提示。
   - **测试合并**：在 Story 6 测试中顺带验证（双指操作时不产生 Scale 事件）。

   ### Story 6：双指滚轮（替代双指缩放）
   **验收标准：**
   - 双指接触：远端光标锁定两指中点。
   - 双指移动：仅触发滚轮事件，光标位置不随手指移动（锁定）。
   - 双指上滑=滚轮下滚，双指下滑=滚轮上滚。
   - 必须通过 U2 验证：Input Event Log 显示 `wheel_v` 事件；日志断言光标位置未发生大范围漂移。

   ---

   ## 七、虚拟输入与快捷键

   ### Story 7：新增组合快捷键按钮面板
   **验收标准：**
   - 显示一组快捷键按钮（如 `Ctrl+C`）；支持增删/显示/隐藏。
   - 支持短按（触发一次）与按住（双击锁定状态）。
   - 配置持久化保存。
   - 必须通过 U2 验证：面板开关状态、新增流程 UI 交互、重启 App 后按钮存在。

   ### Story 8：新增“呼出安卓输入法”按钮
   **验收标准：**
   - 点击圆形按钮弹出/收起系统输入法。
   - 必须通过 U2 验证：检测系统输入法窗口可见性或 App 内键盘状态标识。

   ### Story 9：设置项——隐藏键盘工具条黑色区域
   **验收标准：**
   - 开启设置后，呼出输入法时不显示上方黑色工具条。
   - 必须通过 U2 验证：截图或检查 UI 树中无该工具条元素。

   ---

   ## 八、系统与界面行为调整

   ### Story 10：禁用更新检查
   **验收标准：**
   - Android 端设置页中“检查更新”相关入口被**隐藏**或**置灰不可用**，并提示已禁用。
   - 必须通过 U2 验证：UI 状态断言（检查按钮状态 `enabled=false` 或 `visible=false`）。
   - *注：不再要求 U2 验证底层网络请求。*

   ---

   ## 九、悬浮控件与交互增强

   ### Story 11：悬浮按钮可拖动并持久化
   **验收标准：**
   - 隐藏状态栏后显示悬浮球；可拖动到任意位置。
   - 位置持久化：退出重进后位置保持。
   - 必须通过 U2 验证：拖动 -> 记录坐标 -> 重启 App -> 验证坐标一致（允许少量像素误差）。

   ### Story 12：竖直滑杆（滚轮+中键）
   **验收标准：**
   - 拖动滑杆触发滚轮事件；松手后滑块回弹归位。
   - 双击滑杆中部=中键；双击非中部=选中可移动控件。
   - 必须通过 U2 验证：
     - 拖动产生 `wheel` 日志。
     - 松手 1 秒后，验证滑块中心点坐标回归初始值（不验证回弹动画过程）。

   ---

   ## 十三、自动化测试（UIAutomator2）与验收口径

   所有 Story 开发必须伴随 U2 自动化脚本。为保证测试稳定性，采用“Input Event Log Overlay”作为主要断言依据。

   ### 13.1 测试基础设施 (Mandatory)

   在开发任何功能前，必须在 **Debug 构建** 中实现：
   1.  **Input Event Log Overlay（输入事件日志面板）**：
       - 实时显示最近的输入事件（类型、坐标、时间戳）。
       - 必须具备 `Semantics` 标签，以便 U2 读取文本内容。
   2.  **E2E Mode 开关**：
       - 强制开启日志面板，屏蔽无关弹窗。

   ### 13.2 测试策略调整

   | Story                  | 测试方法                | 关键断言 (Assertion)                                   |
   | ---------------------- | ----------------------- | ------------------------------------------------------ |
   | **S1, S3** (左键/拖动) | U2 模拟单点触控         | 读取 Log 面板：`left_click` / `left_drag`              |
   | **S2, S4** (右键/拖动) | U2 模拟长按/拖动        | 读取 Log 面板：`right_click` / `right_drag` (验证互斥) |
   | **S6, S5** (双指/缩放) | **ADB/U2 底层注入坐标** | 读取 Log 面板：`wheel_v` 且 **无** `scale` 事件        |
   | **S10** (更新)         | UI 状态检查             | 断言设置页“更新”按钮不可用/不可见                      |
   | **S12** (滑杆)         | 状态前后比对            | 操作后 Log 有事件；松手后 UI 坐标归位                  |

   ---

   ## 十四、交付顺序（分组里程碑模式）

   为确保代码稳定性与测试有效性，采用分组交付，每组内的 Story 需一起联调通过后合并。

   ### Milestone 1：基建与净化 (Foundation)
   **目标**：建立测试底座，清理冲突逻辑。
   1.  **Infrastructure**：实现 Input Event Log Overlay 与 E2E 开关（**首要任务**）。
   2.  **Story 10 (禁用更新)**：排除弹窗干扰。
   3.  **Story 5 (移除缩放) & Story 1 (左键点击)**：清理旧手势，验证最基础点击。

   ### Milestone 2：核心手势状态机 (Gesture State Machine)
   **目标**：攻克单指手势的复杂互斥逻辑。
   1.  **Story 3 (左键拖动)**：确立 Pan 手势主导地位。
   2.  **Story 2 (右键长按) & Story 4 (右键拖动)**：实现 LongPress 与 Pan 的状态切换与互斥。

   ### Milestone 3：滚动体验 (Scrolling & Control)
   **目标**：完善滚动交互。
   1.  **Story 6 (双指滚轮)**：实现双指识别与滚轮映射。
   2.  **Story 12 (竖直滑杆)**：实现 UI 层的替代滚轮方案。

   ### Milestone 4：虚拟输入增强 (Virtual Input & UI)
   **目标**：完善生产力 UI。
   1.  **Story 11 (悬浮球)**：实现可拖动 Widget 基类。
   2.  **Story 8 (键盘按钮) & Story 9 (黑条设置)**：输入法交互。
   3.  **Story 7 (快捷键面板)**：基于上述能力实现复杂的快捷键管理面板。

   ---

   ## 十五、风险评估

   - **手势冲突**：S2/S4 与 S3 的识别阈值调整是难点，需在 Milestone 2 重点回归。
   - **多指测试稳定性**：Emulator 的多指注入可能不稳定，S6 测试脚本需预留容错机制（如重试或使用底层 input 命令）。
