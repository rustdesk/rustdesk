name: Build Windows MSI (single file, settings editable)

on:
  workflow_dispatch:
    inputs:
      rendezvous:
        description: "hbbs host:port (через запятую для нескольких, можно пусто)"
        required: false
        default: ""
      relay:
        description: "hbbr host:port (не обязательно)"
        required: false
        default: ""

jobs:
  build:
    runs-on: windows-latest
    env:
      RS_PUB_KEY: ${{ secrets.RS_PUB_KEY }}
      RENDEZVOUS_FALLBACK: ${{ secrets.RENDEZVOUS }}
      RELAY_FALLBACK: ${{ secrets.RELAY }}
      VCPKG_DEFAULT_TRIPLET: x64-windows-static

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install build tools (LLVM/Git/WiX)
        shell: pwsh
        run: |
          choco install -y llvm git wixtoolset

      # vcpkg: манифест + классик (кодеки)
      - name: Install vcpkg (manifest deps) for static
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg "$env:GITHUB_WORKSPACE\vcpkg"
          & "$env:GITHUB_WORKSPACE\vcpkg\bootstrap-vcpkg.bat"
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          & "$env:VCPKG_ROOT\vcpkg" install --triplet x64-windows-static

      - name: Ensure codecs in classic mode (to $VCPKG_ROOT\installed)
        shell: pwsh
        run: |
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          $trip = "x64-windows-static"
          & "$env:VCPKG_ROOT\vcpkg" install --classic --triplet $trip opus libvpx libyuv aom
          & "$env:VCPKG_ROOT\vcpkg" list --triplet $trip

      - name: Verify opus headers exist (classic path)
        shell: pwsh
        run: |
          $hdr = Join-Path $env:GITHUB_WORKSPACE "vcpkg\installed\x64-windows-static\include\opus\opus_multistream.h"
          if (Test-Path $hdr) {
            Write-Host "Found: $hdr"
          } else {
            Write-Error "opus_multistream.h missing under vcpkg\installed"
          }

      # Патч: только дефолты (оставляем возможность менять в UI)
      - name: Resolve inputs/secrets
        id: cfg
        shell: bash
        run: |
          RDV="${{ github.event.inputs.rendezvous }}"
          RLY="${{ github.event.inputs.relay }}"
          [ -z "$RDV" ] && RDV="${RENDEZVOUS_FALLBACK}"
          [ -z "$RLY" ] && RLY="${RELAY_FALLBACK}"
          [ -z "$RS_PUB_KEY" ] && { echo "RS_PUB_KEY required"; exit 1; }
          echo "rdv=$RDV" >> $GITHUB_OUTPUT
          echo "rly=$RLY" >> $GITHUB_OUTPUT

      - name: Patch defaults in config.rs (keep UI editable)
        shell: bash
        env:
          RDV_INPUT: ${{ steps.cfg.outputs.rdv }}
        run: |
          set -e
          CFG="libs/hbb_common/src/config.rs"
          test -f "$CFG" || CFG=$(git grep -l 'RS_PUB_KEY' | head -n1)
          [ -z "$CFG" ] && { echo "RS_PUB_KEY const file not found"; exit 1; }

          SAFE_KEY=$(printf '%s' "$RS_PUB_KEY" | sed 's/\\/\\\\/g; s/"/\\"/g')
          RDV_ARRAY=$(printf '%s' "$RDV_INPUT" | awk -v q='"' 'BEGIN{FS=","; ORS=""}{printf "&["; for(i=1;i<=NF;i++){gsub(/^ +| +$/, "", $i); if(i>1)printf ", "; printf q $i q} printf "]"}')

          perl -0777 -pe "s#(?s)pub const RS_PUB_KEY:.*?;#pub const RS_PUB_KEY: &'static str = \"$SAFE_KEY\";#g" -i "$CFG" || true
          perl -0777 -pe "s#(?s)(pub const RENDEZVOUS_SERVERS:\s*[^=]+=\s*)[^;]*;#\${1}${RDV_ARRAY};#g" -i "$CFG" || true

      # Сборка exe (все переменные ставим внутри PowerShell — без YAML env)
      - name: Build (release)
        shell: pwsh
        run: |
          # Vars that were causing YAML parsing issues — set them here:
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          $env:VCPKG_DEFAULT_TRIPLET = "x64-windows-static"
          $env:LIBCLANG_PATH = "C:\Program Files\LLVM\bin"
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I$env:GITHUB_WORKSPACE/vcpkg/installed/x64-windows-static/include"
          $env:PKG_CONFIG_PATH = "$env:GITHUB_WORKSPACE\vcpkg\installed\x64-windows-static\lib\pkgconfig"

          # Sciter DLL рядом с бинарём — положим и потом включим в MSI
          New-Item -ItemType Directory -Force -Path target\debug | Out-Null
          Invoke-WebRequest https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.win/x64/sciter.dll -OutFile target\debug\sciter.dll

          cargo build --release
          Copy-Item target\debug\sciter.dll target\release\

      - name: Upload raw binaries (optional)
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-release-bin
          path: |
            target/release/rustdesk.exe
            target/release/sciter.dll

      # WiX: один MSI
      - name: Generate minimal WiX Product.wxs
        shell: pwsh
        run: |
          $wxs = @"
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:ui="http://schemas.microsoft.com/wix/UIExtension">
  <Product
    Id="*"
    Name="RustDesk Custom"
    Manufacturer="Your Company"
    Version="1.0.0"
    Language="1033"
    UpgradeCode="8B6B6B3A-9E56-4E2E-9A8E-6B2C6E5C1111">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <Feature Id="MainFeature" Title="RustDesk Custom" Level="1">
      <ComponentGroupRef Id="AppFiles" />
    </Feature>

    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLDIR" Name="RustDesk Custom" />
      </Directory>
    </Directory>
  </Product>
</Wix>
"@
          Set-Content -Encoding UTF8 -NoNewline -Path Product.wxs -Value $wxs

      - name: Harvest files with heat.exe
        shell: pwsh
        run: |
          $ReleaseDir = Join-Path $env:GITHUB_WORKSPACE "target\release"
          & "C:\Program Files (x86)\WiX Toolset v3.11\bin\heat.exe" dir $ReleaseDir -gg -sfrag -srd -sreg -dr INSTALLDIR -cg AppFiles -var var.SourceDir -out harvest.wxs

      - name: Compile WiX (candle)
        shell: pwsh
        run: |
          $ReleaseDir = Join-Path $env:GITHUB_WORKSPACE "target\release"
          & "C:\Program Files (x86)\WiX Toolset v3.11\bin\candle.exe" -arch x64 -dSourceDir="$ReleaseDir" Product.wxs harvest.wxs -ext WixUIExtension -ext WixUtilExtension

      - name: Link WiX (light) -> MSI single file
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\WiX Toolset v3.11\bin\light.exe" -cultures:en-us Product.wixobj harvest.wixobj -ext WixUIExtension -ext WixUtilExtension -out RustDesk-Custom-x64.msi

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-msi
          path: RustDesk-Custom-x64.msi
