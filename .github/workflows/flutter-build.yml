name: Build Windows Only

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘å¼€å…³
  push:
    branches: [ master ]

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-2022 # æŒ‡å®šä½¿ç”¨ Windows ç¯å¢ƒ
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸŸ¢ Apply Custom Server Config (å¼ºåˆ¶ä¿®æ”¹é…ç½®)
        shell: bash
        run: |
          echo "å¼€å§‹ä¿®æ”¹é…ç½®..."
          # 1. æ›¿æ¢åŸŸå (å…¨å±€æ›¿æ¢ rustdesk.com)
          grep -rl "rustdesk.com" . | xargs sed -i 's/rustdesk.com/www.wzais.top/g'
          
          # 2. å¼ºåˆ¶æ‹¦æˆªè·å– ID æœåŠ¡å™¨çš„å‡½æ•°
          grep -rl "bind.mainGetIdServer()" . | xargs sed -i 's/bind.mainGetIdServer()/"www.wzais.top"/g'
          
          # 3. å¼ºåˆ¶æ‹¦æˆªè·å– Key çš„å‡½æ•°
          grep -rl "bind.mainGetKey()" . | xargs sed -i 's/bind.mainGetKey()/"123456"/g'
          
          # 4. å¼ºåˆ¶æ‹¦æˆª API æœåŠ¡å™¨ (å¦‚æœ‰)
          grep -rl "bind.mainGetApiServer()" . | xargs sed -i 's|bind.mainGetApiServer()|"http://www.wzais.top:21114"|g'
          
          echo "é…ç½®ä¿®æ”¹å®Œæˆï¼"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install vcpkg (C++ä¾èµ–)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55437'

      - name: Build RustDesk (Release Mode)
        run: |
          # è¿›å…¥ flutter ç›®å½•æ„å»º
          cd flutter
          flutter pub get
          flutter build windows --release --verbose

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-custom
          path: flutter/build/windows/x64/runner/Release/*.exe
