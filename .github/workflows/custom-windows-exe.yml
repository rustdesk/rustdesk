name: Custom Windows EXE Build
on:
  workflow_dispatch:

jobs:
  build-windows-exe:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      # Проверка конфигурации серверов
      - name: Verify Config Settings
        run: |
          if (-not (Select-String -Path libs/hbb_common/src/config.rs -Pattern "web-srv.smol-it.ru")) {
            Write-Error "web-srv.smol-it.ru not found in config.rs"
            exit 1
          }
          if (-not (Select-String -Path libs/hbb_common/src/config.rs -Pattern "HFbRpr1f56XisOb5Ext6PNnWFpjyO3Ew6SLzfbJg88w=")) {
            Write-Error "API key not found in config.rs"
            exit 1
          }
        shell: pwsh

      # Сборка БЕЗ hwcodec/vram (надёжный вариант)
      - name: Build RustDesk
        run: |
          python ./build.py --portable --flutter --skip-portable-pack
          
          # Проверяем успешность сборки
          if (-not (Test-Path "./flutter/build/windows/x64/runner/Release")) {
            Write-Error "Build failed: Release directory not found"
            Get-ChildItem -Path "./flutter/build/windows/x64/runner/" -Recurse -ErrorAction SilentlyContinue
            exit 1
          }
          
          Move-Item -Path ./flutter/build/windows/x64/runner/Release -Destination ./rustdesk
        shell: pwsh

      # Создание одиночного .exe файла
      - name: Create single EXE
        run: |
          # Корректное удаление dpiAware через PowerShell (безопасная замена sed)
          $manifestPath = "res/manifest.xml"
          if (Test-Path $manifestPath) {
            $content = Get-Content -Path $manifestPath -Raw
            # Удаляем всю секцию <application> с dpiAware
            $content = $content -replace '(?ms)\s*<application\b[^>]*>.*?</application>', ''
            Set-Content -Path $manifestPath -Value $content
          }

          # Генерация портативного пакета
          cd libs/portable
          pip install -r requirements.txt
          python ./generate.py -f ../../rustdesk/ -o . -e ../../rustdesk/rustdesk.exe
          cd ../..

          # Перемещаем результат
          New-Item -ItemType Directory -Path ./dist -Force
          
          $packerPath = "./target/release/rustdesk-portable-packer.exe"
          if (-not (Test-Path $packerPath)) {
            $packerPath = "./rustdesk/rustdesk-portable-packer.exe"
          }
          
          if (-not (Test-Path $packerPath)) {
            Write-Error "rustdesk-portable-packer.exe not found in expected locations"
            Get-ChildItem -Path "./target/release/" -Filter "*rustdesk*" -Recurse -ErrorAction SilentlyContinue
            Get-ChildItem -Path "./rustdesk/" -Filter "*rustdesk*" -Recurse -ErrorAction SilentlyContinue
            exit 1
          }
          
          Move-Item -Path $packerPath -Destination ./dist/rustdesk-custom.exe
        shell: pwsh

      # Загрузка результата сборки
      - name: Upload Single EXE
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-single-exe
          path: ./dist/rustdesk-custom.exe
          retention-days: 30
