name: ðŸ” CQNTå®šåˆ¶RustDeskå®‰å…¨ç¼–è¯‘

on:
  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'ç¼–è¯‘Windowsç‰ˆæœ¬'
        required: true
        default: true
        type: boolean
      build_linux:
        description: 'ç¼–è¯‘Linuxç‰ˆæœ¬'
        required: true
        default: true
        type: boolean
      build_macos:
        description: 'ç¼–è¯‘macOSç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

  # ä»£ç æŽ¨é€æ—¶è‡ªåŠ¨ç¼–è¯‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'Cargo.toml'

# æ‰€æœ‰æ•æ„Ÿé…ç½®ä»ŽGitHub Secretsè¯»å–ï¼Œä¸åœ¨ä»£ç ä¸­æš´éœ²
  
jobs:
  validate-secrets:
    name: ðŸ” éªŒè¯Secretsé…ç½®
    runs-on: ubuntu-latest
    
    steps:
    - name: éªŒè¯å¿…éœ€çš„Secrets
      run: |
        echo "ðŸ” æ£€æŸ¥å¿…éœ€çš„Secretsé…ç½®..."
        
        # æ£€æŸ¥å¿…éœ€çš„Secrets (ç®€åŒ–åŽçš„6ä¸ªå¿…éœ€é…ç½®)
        if [ -z "${{ secrets.RUSTDESK_SERVER_HOST }}" ]; then
          echo "âŒ é”™è¯¯: RUSTDESK_SERVER_HOST æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.RUSTDESK_HBBS_PORT }}" ]; then
          echo "âŒ é”™è¯¯: RUSTDESK_HBBS_PORT æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.RUSTDESK_SERVER_KEY }}" ]; then
          echo "âŒ é”™è¯¯: RUSTDESK_SERVER_KEY æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.CQNT_BACKEND_HOST }}" ]; then
          echo "âŒ é”™è¯¯: CQNT_BACKEND_HOST æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.CQNT_APP_NAME }}" ]; then
          echo "âŒ é”™è¯¯: CQNT_APP_NAME æœªé…ç½®"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰å¿…éœ€çš„Secretsé…ç½®æ£€æŸ¥é€šè¿‡"
        
        # æ˜¾ç¤ºé…ç½®ä¿¡æ¯ï¼ˆè„±æ•ï¼‰
        echo "ðŸ“‹ å½“å‰é…ç½®ï¼š"
        echo "  RustDeskæœåŠ¡ç«¯: ${{ secrets.RUSTDESK_SERVER_HOST }}:${{ secrets.RUSTDESK_HBBS_PORT }}"
        echo "  CQNTç®¡ç†åŽç«¯: ${{ secrets.CQNT_BACKEND_HOST }}:${{ secrets.CQNT_BACKEND_PORT }}"
        echo "  åº”ç”¨åç§°: ${{ secrets.CQNT_APP_NAME }}"
        
        # æ£€æŸ¥å¯†é’¥é•¿åº¦ï¼ˆä¸æ˜¾ç¤ºå†…å®¹ï¼‰
        key_length=$(echo -n "${{ secrets.RUSTDESK_SERVER_KEY }}" | wc -c)
        echo "  æœåŠ¡å™¨å¯†é’¥: [å·²é…ç½®ï¼Œé•¿åº¦: ${key_length} å­—ç¬¦]"

  build-windows:
    name: ðŸªŸ ç¼–è¯‘Windowså®¢æˆ·ç«¯
    runs-on: windows-latest
    needs: validate-secrets
    if: github.event.inputs.build_windows != 'false'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: ðŸ”„ æ›´æ–°å­æ¨¡å—
      run: |
        Write-Host "ðŸ”„ åˆå§‹åŒ–å¹¶æ›´æ–°Gitå­æ¨¡å—..."
        git submodule update --init --recursive --force
        Write-Host "ðŸ“‹ æ£€æŸ¥å…³é”®å­æ¨¡å—ï¼š"
        if (Test-Path "libs\hbb_common") {
          Write-Host "  âœ… hbb_common å­æ¨¡å—å­˜åœ¨"
        } else {
          Write-Host "  âŒ hbb_common å­æ¨¡å—ç¼ºå¤±ï¼Œå°è¯•æ‰‹åŠ¨å…‹éš†..."
          git clone https://github.com/rustdesk/hbb_common.git libs\hbb_common
        }
        if (Test-Path "libs\scrap") {
          Write-Host "  âœ… scrap å­æ¨¡å—å­˜åœ¨"  
        } else {
          Write-Host "  âŒ scrap å­æ¨¡å—ç¼ºå¤±ï¼Œå°è¯•æ‰‹åŠ¨å…‹éš†..."
          git clone https://github.com/rustdesk/rust_scrap.git libs\scrap
        }
        
    - name: ðŸ¦€ å®‰è£…Rustå·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: ðŸ“¦ å®‰è£…vcpkgä¾èµ–
      run: |
        vcpkg install libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static
        echo "VCPKG_ROOT=${{ github.workspace }}\\vcpkg" >> $env:GITHUB_ENV
        
    - name: ðŸ”§ ç”ŸæˆCQNTå®šåˆ¶é…ç½®
      run: |
        Write-Host "ðŸ”§ ç”ŸæˆCQNTå®šåˆ¶é…ç½®æ–‡ä»¶..."
        
        # æž„å»ºRustDeské…ç½®JSON
        $config = @{
            "app-name" = "${{ secrets.CQNT_APP_NAME }}"
            "default-settings" = @{
                "custom-rendezvous-server" = "${{ secrets.RUSTDESK_SERVER_HOST }}:${{ secrets.RUSTDESK_HBBS_PORT }}"
                "api-server" = "http://${{ secrets.CQNT_BACKEND_HOST }}:${{ secrets.CQNT_BACKEND_PORT }}"
                "key" = "${{ secrets.RUSTDESK_SERVER_KEY }}"
            }
            "override-settings" = @{
                "custom-rendezvous-server" = "${{ secrets.RUSTDESK_SERVER_HOST }}:${{ secrets.RUSTDESK_HBBS_PORT }}"
            }
        }
        
        # è½¬æ¢ä¸ºJSONå¹¶ä¿å­˜
        $jsonConfig = $config | ConvertTo-Json -Depth 3 -Compress
        $jsonBytes = [System.Text.Encoding]::UTF8.GetBytes($jsonConfig)
        $base64Config = [Convert]::ToBase64String($jsonBytes)
        
        # åˆ›å»ºcustom.txtæ–‡ä»¶ (æ³¨æ„ï¼šè¿™æ˜¯ç®€åŒ–ç‰ˆï¼Œç”Ÿäº§çŽ¯å¢ƒéœ€è¦ç­¾å)
        Write-Output $base64Config | Out-File -FilePath "custom.txt" -Encoding ASCII
        
        Write-Host "ðŸ“‹ ç”Ÿæˆçš„é…ç½®ï¼š"
        Write-Host "  IDæœåŠ¡å™¨: ${{ secrets.RUSTDESK_SERVER_HOST }}:${{ secrets.RUSTDESK_HBBS_PORT }}"
        Write-Host "  APIæœåŠ¡å™¨: http://${{ secrets.CQNT_BACKEND_HOST }}:${{ secrets.CQNT_BACKEND_PORT }}"
        Write-Host "  åº”ç”¨åç§°: ${{ secrets.CQNT_APP_NAME }}"
        Write-Host "  é…ç½®æ–‡ä»¶: custom.txt (å·²ç”Ÿæˆ)"
        
    - name: ðŸš€ ç¼–è¯‘RustDeskå®¢æˆ·ç«¯
      run: |
        Write-Host "ðŸš€ å¼€å§‹ç¼–è¯‘Windowså®¢æˆ·ç«¯..."
        Write-Host "ðŸ“‚ å½“å‰ç›®å½•: $(Get-Location)"
        Write-Host "ðŸ“‚ æ£€æŸ¥Cargo.toml: $(Test-Path 'Cargo.toml')"
        if (Test-Path 'Cargo.toml') {
          Write-Host "âœ… åœ¨æ ¹ç›®å½•ç¼–è¯‘"
          cargo build --release --features flutter
        } else {
          Write-Host "âŒ Cargo.tomlæœªæ‰¾åˆ°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¿›å…¥å­ç›®å½•"
          exit 1
        }
        
    - name: ðŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        $version = "1.4.3-CQNT-$(Get-Date -Format 'yyyyMMdd')"
        $filename = "CQNT_RustDesk_${version}_windows_x64.exe"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "filename=$filename" >> $env:GITHUB_OUTPUT
        
    - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir release
        # æ£€æŸ¥ç¼–è¯‘äº§ç‰©è·¯å¾„
        Write-Host "ðŸ“‚ æ£€æŸ¥ç¼–è¯‘äº§ç‰©ï¼š"
        if (Test-Path "target\release\rustdesk.exe") {
          Write-Host "âœ… æ‰¾åˆ°ç¼–è¯‘äº§ç‰©: target\release\rustdesk.exe"
          copy "target\release\rustdesk.exe" "release\${{ steps.version.outputs.filename }}"
        } else {
          Write-Host "âŒ ç¼–è¯‘äº§ç‰©æœªæ‰¾åˆ°"
          Get-ChildItem -Path "target" -Recurse -Name "*.exe" | ForEach-Object { Write-Host "  å‘çŽ°: $_" }
          exit 1
        }
        
        # åˆ›å»ºé…ç½®ä¿¡æ¯æ–‡ä»¶
        @"
        CQNTå®šåˆ¶RustDeskå®¢æˆ·ç«¯
        ========================
        
        ç‰ˆæœ¬: ${{ steps.version.outputs.version }}
        ç¼–è¯‘æ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        
        å†…ç½®é…ç½®:
        - IDæœåŠ¡å™¨: $env:RENDEZVOUS_SERVER
        - APIæœåŠ¡å™¨: $env:API_SERVER
        - åº”ç”¨åç§°: $env:RUSTDESK_APP_NAME
        
        ä½¿ç”¨è¯´æ˜Ž:
        1. ç›´æŽ¥è¿è¡Œexeæ–‡ä»¶
        2. è‡ªåŠ¨è¿žæŽ¥åˆ°CQNTæœåŠ¡å™¨
        3. æ— éœ€ä»»ä½•é¢å¤–é…ç½®
        
        æŠ€æœ¯æ”¯æŒ: CQNTæŠ€æœ¯å›¢é˜Ÿ
        "@ | Out-File -FilePath "release\ä½¿ç”¨è¯´æ˜Ž.txt" -Encoding UTF8
        
    - name: ðŸŽ¯ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: CQNT-RustDesk-Windows
        path: release/
        
  build-linux:
    name: ðŸ§ ç¼–è¯‘Linuxå®¢æˆ·ç«¯  
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake git pkg-config \
          libasound2-dev libpulse-dev libgtk-3-dev \
          libxcb-randr0-dev libxdo-dev libxfixes-dev \
          libxcb-shape0-dev libxcb-xfixes0-dev \
          libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
          libpam0g-dev clang libclang-dev ninja-build \
          nasm yasm
          
    - name: ðŸ¦€ å®‰è£…Rustå·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: ðŸ“¦ å®‰è£…vcpkgä¾èµ–
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        ./bootstrap-vcpkg.sh
        ./vcpkg install libvpx libyuv opus aom
        echo "VCPKG_ROOT=${{ github.workspace }}/vcpkg" >> $GITHUB_ENV
        
    - name: ðŸš€ ç¼–è¯‘RustDeskå®¢æˆ·ç«¯
      run: |
        cd rustdesk-master
        cargo build --release --features flutter
        
    - name: ðŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        version="1.4.3-CQNT-$(date +%Y%m%d)"
        filename="CQNT_RustDesk_${version}_linux_x64"
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "filename=$filename" >> $GITHUB_OUTPUT
        
    - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir release
        cp rustdesk-master/target/release/rustdesk "release/${{ steps.version.outputs.filename }}"
        chmod +x "release/${{ steps.version.outputs.filename }}"
        
        # åˆ›å»ºé…ç½®ä¿¡æ¯æ–‡ä»¶
        cat > release/ä½¿ç”¨è¯´æ˜Ž.txt << EOF
        CQNTå®šåˆ¶RustDeskå®¢æˆ·ç«¯ (Linuxç‰ˆ)
        ================================
        
        ç‰ˆæœ¬: ${{ steps.version.outputs.version }}
        ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        
        å†…ç½®é…ç½®:
        - IDæœåŠ¡å™¨: $RENDEZVOUS_SERVER
        - APIæœåŠ¡å™¨: $API_SERVER  
        - åº”ç”¨åç§°: $RUSTDESK_APP_NAME
        
        å®‰è£…è¯´æ˜Ž:
        1. chmod +x ${{ steps.version.outputs.filename }}
        2. ./${{ steps.version.outputs.filename }}
        3. è‡ªåŠ¨è¿žæŽ¥åˆ°CQNTæœåŠ¡å™¨
        
        ç³»ç»Ÿè¦æ±‚: Linux x64, GTK3
        æŠ€æœ¯æ”¯æŒ: CQNTæŠ€æœ¯å›¢é˜Ÿ
        EOF
        
    - name: ðŸŽ¯ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: CQNT-RustDesk-Linux
        path: release/
        
  # å¯é€‰ï¼šmacOSç¼–è¯‘
  build-macos:
    name: ðŸŽ ç¼–è¯‘macOSå®¢æˆ·ç«¯
    runs-on: macos-latest
    if: false  # é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦æ—¶æ”¹ä¸ºtrue
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£…Rustå·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        brew install cmake pkg-config
        
    - name: ðŸš€ ç¼–è¯‘RustDeskå®¢æˆ·ç«¯
      run: |
        cd rustdesk-master
        cargo build --release --features flutter
        
    - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir release
        cp rustdesk-master/target/release/rustdesk "release/CQNT_RustDesk_macos_$(date +%Y%m%d)"
        
    - name: ðŸŽ¯ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: CQNT-RustDesk-macOS
        path: release/
