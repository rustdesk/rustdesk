name: Build Windows client (servers hidden, static triplet)

on:
  workflow_dispatch:
    inputs:
      rendezvous:
        description: "hbbs host:port (через запятую для нескольких)"
        required: false
        default: ""
      relay:
        description: "hbbr host:port (пусто — из секретов)"
        required: false
        default: ""

jobs:
  build:
    runs-on: windows-latest
    env:
      RS_PUB_KEY: ${{ secrets.RS_PUB_KEY }}
      RENDEZVOUS_FALLBACK: ${{ secrets.RENDEZVOUS }}
      RELAY_FALLBACK: ${{ secrets.RELAY }}
      VCPKG_DEFAULT_TRIPLET: x64-windows-static

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install LLVM & Git
        shell: powershell
        run: choco install -y llvm git

      # 1) Установим vcpkg и manifest-зависимости (в <repo>\vcpkg_installed\...)
      - name: Install vcpkg (manifest deps) for static
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg $env:GITHUB_WORKSPACE\vcpkg
          & $env:GITHUB_WORKSPACE\vcpkg\bootstrap-vcpkg.bat
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          & $env:VCPKG_ROOT\vcpkg install --triplet x64-windows-static

      # 2) Обязательно доставим кодеки в classic-mode в $VCPKG_ROOT\installed
      - name: Ensure codecs in classic mode (to $VCPKG_ROOT\installed)
        shell: powershell
        run: |
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          $trip = "x64-windows-static"
          & $env:VCPKG_ROOT\vcpkg install --classic --triplet $trip opus libvpx libyuv aom
          & $env:VCPKG_ROOT\vcpkg list --triplet $trip

      - name: Verify opus headers exist (classic path)
        shell: powershell
        run: |
          $dir = Join-Path $env:GITHUB_WORKSPACE "vcpkg\installed\x64-windows-static\include\opus"
          Get-ChildItem $dir -ErrorAction SilentlyContinue
          $hdr = Join-Path $dir "opus_multistream.h"
          if (Test-Path $hdr) { Write-Host "Found: $hdr" } else { Write-Error "opus_multistream.h still missing under vcpkg\\installed"; exit 1 }

      # 3) Соберём входные параметры
      - name: Resolve inputs/secrets
        id: cfg
        shell: bash
        run: |
          RDV="${{ github.event.inputs.rendezvous }}"
          RLY="${{ github.event.inputs.relay }}"
          [ -z "$RDV" ] && RDV="${RENDEZVOUS_FALLBACK}"
          [ -z "$RLY" ] && RLY="${RELAY_FALLBACK}"
          [ -z "$RS_PUB_KEY" ] && { echo "RS_PUB_KEY required"; exit 1; }
          echo "rdv=$RDV" >> $GITHUB_OUTPUT
          echo "rly=$RLY" >> $GITHUB_OUTPUT

      # 4) Патч: вшиваем публичный ключ и RENDEZVOUS (как массив строк!)
      - name: Patch 1 — inject servers/key (RENDEZVOUS as array)
        shell: bash
        env:
          RDV_INPUT: ${{ steps.cfg.outputs.rdv }}
        run: |
          set -e
          CFG="libs/hbb_common/src/config.rs"
          test -f "$CFG" || CFG=$(git grep -l 'RS_PUB_KEY' | head -n1)
          [ -z "$CFG" ] && { echo "Не нашли файл с RS_PUB_KEY"; exit 1; }

          SAFE_KEY=$(printf '%s' "$RS_PUB_KEY" | sed 's/\\/\\\\/g; s/"/\\"/g')
          RDV_ARRAY=$(printf '%s' "$RDV_INPUT" | awk -v q='"' 'BEGIN{FS=","; ORS=""}{printf "&["; for(i=1;i<=NF;i++){gsub(/^ +| +$/, "", $i); if(i>1)printf ", "; printf q $i q} printf "]"}')

          perl -0777 -pe "s#(?s)pub const RS_PUB_KEY:.*?;#pub const RS_PUB_KEY: &'static str = \"$SAFE_KEY\";#g" -i "$CFG" || true
          perl -0777 -pe "s#(?s)(pub const RENDEZVOUS_SERVERS:\s*[^=]+=\s*)[^;]*;#\${1}${RDV_ARRAY};#g" -i "$CFG" || true

      # ⚠️ БОЛЬШЕ НЕ ТРОГАЕМ исходники ради "обнуления" — это ломало сборку.
      # Скрываем только UI раздел Network, чтобы строки не светились пользователю.

      # 5) Скрыть/удалить UI "Settings → Network"
      - name: Patch 2 — hide/remove UI "Settings → Network"
        shell: bash
        run: |
          set -e
          git rm -f src/ui/settings/network* 2>/dev/null || true
          FILES=$(git grep -l -E 'Network|network' src/ui 2>/dev/null || true)
          for f in $FILES; do
            sed -i.bak -E 's/.*Settings.*Network.*//g' "$f" || true
            sed -i.bak -E 's/.*Network.*//g' "$f" || true
            sed -i.bak -E 's/.*network.*//g' "$f" || true
          done
          if grep -q '\[features\]' Cargo.toml; then
            perl -0777 -pe 's#default = \[(.*?)\]#default = [\1, "inline"]#s' -i Cargo.toml || true
          fi
          python -V >/dev/null 2>&1 && python res/inline-sciter.py || true

      # 6) Sciter DLL для GUI
      - name: Place Sciter DLL
        shell: bash
        run: |
          mkdir -p target/debug
          curl -L -o target/debug/sciter.dll https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.win/x64/sciter.dll

      # 7) Сборка релиза (подсказки для bindgen/clang + статический триплет)
      - name: Build (release)
        shell: bash
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
          LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
          BINDGEN_EXTRA_CLANG_ARGS: -I${{ github.workspace }}/vcpkg/installed/x64-windows-static/include
          PKG_CONFIG_PATH: ${{ github.workspace }}\vcpkg\installed\x64-windows-static\lib\pkgconfig
        run: |
          cargo build --release
          cp target/debug/sciter.dll target/release/

      - uses: actions/upload-artifact@v4
        with:
          name: rustdesk-win-hidden-network
          path: |
            target/release/rustdesk.exe
            target/release/sciter.dll
