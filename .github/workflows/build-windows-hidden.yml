name: Build Windows client (servers hidden, static triplet)

on:
  workflow_dispatch:
    inputs:
      rendezvous:
        description: "hbbs host:port (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö)"
        required: false
        default: ""
      relay:
        description: "hbbr host:port (–ø—É—Å—Ç–æ ‚Äî –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤)"
        required: false
        default: ""

jobs:
  build:
    runs-on: windows-latest
    env:
      # –°–µ–∫—Ä–µ—Ç—ã/–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      RS_PUB_KEY: ${{ secrets.RS_PUB_KEY }}
      RENDEZVOUS_FALLBACK: ${{ secrets.RENDEZVOUS }}
      RELAY_FALLBACK: ${{ secrets.RELAY }}
      # –§–∏–∫—Å–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–∏–ø–ª–µ—Ç –≤–µ–∑–¥–µ
      VCPKG_DEFAULT_TRIPLET: x64-windows-static

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install LLVM & Git
        shell: powershell
        run: choco install -y llvm git

      # 1) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º vcpkg –∏ —Ç—è–Ω–µ–º manifest-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤ <repo>\vcpkg_installed\...)
      - name: Install vcpkg (manifest deps) for static
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg $env:GITHUB_WORKSPACE\vcpkg
          & $env:GITHUB_WORKSPACE\vcpkg\bootstrap-vcpkg.bat
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          & $env:VCPKG_ROOT\vcpkg install --triplet x64-windows-static

      # 2) –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¥–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥–µ–∫–∏ –≤ classic-—Ä–µ–∂–∏–º–µ –≤ $VCPKG_ROOT\installed\...
      - name: Ensure codecs in classic mode (to $VCPKG_ROOT\installed)
        shell: powershell
        run: |
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"
          $trip = "x64-windows-static"
          & $env:VCPKG_ROOT\vcpkg install --classic --triplet $trip opus libvpx libyuv aom
          & $env:VCPKG_ROOT\vcpkg list --triplet $trip

      # 3) –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ opus –ø–æ—è–≤–∏–ª–∏—Å—å —Ç–∞–º, –≥–¥–µ –∏—Ö –∏—â–µ—Ç magnum-opus/clang
      - name: Verify opus headers exist (classic path)
        shell: powershell
        run: |
          $dir = Join-Path $env:GITHUB_WORKSPACE "vcpkg\installed\x64-windows-static\include\opus"
          Get-ChildItem $dir -ErrorAction SilentlyContinue
          $hdr = Join-Path $dir "opus_multistream.h"
          if (Test-Path $hdr) { Write-Host "Found: $hdr" } else { Write-Error "opus_multistream.h still missing under vcpkg\\installed"; exit 1 }

      # 4) –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ inputs/—Å–µ–∫—Ä–µ—Ç–æ–≤
      - name: Resolve inputs/secrets
        id: cfg
        shell: bash
        run: |
          RDV="${{ github.event.inputs.rendezvous }}"
          RLY="${{ github.event.inputs.relay }}"
          [ -z "$RDV" ] && RDV="${RENDEZVOUS_FALLBACK}"
          [ -z "$RLY" ] && RLY="${RELAY_FALLBACK}"
          [ -z "$RS_PUB_KEY" ] && { echo "RS_PUB_KEY required"; exit 1; }
          echo "rdv=$RDV" >> $GITHUB_OUTPUT
          echo "rly=$RLY" >> $GITHUB_OUTPUT

      # 5) –ü–∞—Ç—á: –≤—à–∏–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –∏ —Å–µ—Ä–≤–µ—Ä–∞ (RENDEZVOUS –∫–∞–∫ –º–∞—Å—Å–∏–≤)
      - name: Patch 1 ‚Äî –∑–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä/–∫–ª—é—á (–º–∞—Å—Å–∏–≤ –¥–ª—è RENDEZVOUS_SERVERS)
        shell: bash
        env:
          RDV_INPUT: ${{ steps.cfg.outputs.rdv }}
        run: |
          set -e
          CFG="libs/hbb_common/src/config.rs"
          test -f "$CFG" || CFG=$(git grep -l 'RS_PUB_KEY' | head -n1)
          [ -z "$CFG" ] && { echo "–ù–µ –Ω–∞—à–ª–∏ —Ñ–∞–π–ª —Å RS_PUB_KEY"; exit 1; }

          SAFE_KEY=$(printf '%s' "$RS_PUB_KEY" | sed 's/\\/\\\\/g; s/"/\\"/g')
          RDV_ARRAY=$(printf '%s' "$RDV_INPUT" | awk -v q='"' 'BEGIN{FS=","; ORS=""}{printf "&["; for(i=1;i<=NF;i++){gsub(/^ +| +$/, "", $i); if(i>1)printf ", "; printf q $i q} printf "]"}')

          perl -0777 -pe "s#(?s)pub const RS_PUB_KEY:.*?;#pub const RS_PUB_KEY: &'static str = \"$SAFE_KEY\";#g" -i "$CFG" || true
          perl -0777 -pe "s#(?s)(pub const RENDEZVOUS_SERVERS:\s*[^=]+=\s*)[^;]*;#\${1}${RDV_ARRAY};#g" -i "$CFG" || true

      # 6) –ü–∞—Ç—á: –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–æ–≤
      - name: Patch 2 ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        shell: bash
        run: |
          set -e
          FILES=$(git grep -l -E 'id[_-]?server|relay[_-]?server|RustDesk2\.toml' || true)
          for f in $FILES; do
            sed -i.bak 's/\(id[_-]*server[^\n]*\)=.*/\1 = ""/g' "$f" || true
            sed -i.bak 's/\(relay[_-]*server[^\n]*\)=.*/\1 = ""/g' "$f" || true
          done

      # 7) –ü–∞—Ç—á: —Å–∫—Ä—ã–≤–∞–µ–º/—É–¥–∞–ª—è–µ–º UI "Settings ‚Üí Network"
      - name: Patch 3 ‚Äî —É–¥–∞–ª—è–µ–º/–ø—Ä—è—á–µ–º UI "Settings ‚Üí Network"
        shell: bash
        run: |
          set -e
          git rm -f src/ui/settings/network* 2>/dev/null || true
          FILES=$(git grep -l -E 'Network|network' src/ui 2>/dev/null || true)
          for f in $FILES; do
            sed -i.bak -E 's/.*Network.*//g' "$f" || true
            sed -i.bak -E 's/.*network.*//g' "$f" || true
          done
          if grep -q '\[features\]' Cargo.toml; then
            perl -0777 -pe 's#default = \[(.*?)\]#default = [\1, "inline"]#s' -i Cargo.toml || true
          fi
          python -V >/dev/null 2>&1 && python res/inline-sciter.py || true

      # 8) –ö–ª–∞–¥—ë–º Sciter DLL –¥–ª—è GUI
      - name: Place Sciter DLL
        shell: bash
        run: |
          mkdir -p target/debug
          curl -L -o target/debug/sciter.dll https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.win/x64/sciter.dll

      # 9) –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –¥–ª—è bindgen/clang
      - name: Build (release)
        shell: bash
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
          LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
          # üëá –ü–æ–º–æ–≥–∞–µ–º bindgen/clang –≤–∏–¥–µ—Ç—å –∏–Ω–∫–ª—É–¥—ã opus –∏ –ø—Ä–æ—á–µ–≥–æ –∏–∑ vcpkg
          BINDGEN_EXTRA_CLANG_ARGS: -I${{ github.workspace }}/vcpkg/installed/x64-windows-static/include
          # üëá –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ–π–¥—É—Ç —á–µ—Ä–µ–∑ pkg-config
          PKG_CONFIG_PATH: ${{ github.workspace }}\vcpkg\installed\x64-windows-static\lib\pkgconfig
        run: |
          cargo build --release
          cp target/debug/sciter.dll target/release/

      - uses: actions/upload-artifact@v4
        with:
          name: rustdesk-win-hidden-network
          path: |
            target/release/rustdesk.exe
            target/release/sciter.dll
